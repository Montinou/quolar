# Step 7: PR Creation

**Duration**: ~5-8 minutes
**Purpose**: Evaluate documentation needs, create GitHub PR, execute tests on preview deployment, and validate results.

**Scripts**: `${CLAUDE_PLUGIN_ROOT}/skills/test-ticket/scripts/`

---

## Prerequisites

### Ticket Must Exist in Linear FIRST

**CRITICAL**: Before creating any branch or PR, ensure a Linear ticket exists for this work.

```typescript
// Verify ticket exists
const ticket = await mcp.linear.get_issue({ id: ticketId })

if (!ticket) {
  // Create ticket if it doesn't exist
  const newTicket = await mcp.linear.create_issue({
    title: `E2E Tests: {feature-description}`,
    team: "Engineering",  // or appropriate team
    labels: ["automated-tests", "qa", "e2e"],
    description: `Automated test suite for {feature}\n\nGenerated by Quolar Test Automation`
  })
  ticketId = newTicket.identifier  // e.g., "ENG-456"
}
```

### Branch Naming Convention

**MANDATORY**: Branch name MUST include the ticket ID.

| Pattern | Example |
|---------|---------|
| `test/{ticket-id}` | `test/ENG-123` |
| `test/{ticket-id}-automated-tests` | `test/ENG-123-automated-tests` |
| `test/{ticket-id}-{feature}` | `test/ENG-123-user-login` |

```bash
# Always derive branch name from ticket ID
BRANCH_NAME="test/${TICKET_ID}-automated-tests"

# Example: test/ENG-123-automated-tests
git checkout -b $BRANCH_NAME
```

**âŒ NEVER** create branches without ticket reference:
- `test/automated-tests` âŒ
- `feature/new-tests` âŒ
- `fix/playwright-tests` âŒ

---

## Actions

### 1. Evaluate Documentation Needs (MANDATORY)

**Per project rules**: Before creating PR, evaluate if Quoth documentation needs updates.

#### Compare Generated Code vs Documented Patterns

```typescript
// Search Quoth for patterns used in generated tests
const existingPatterns = await mcp.quoth.quoth_search_index({
  query: "playwright test patterns locators authentication"
})

// Read current documentation
const docs = await mcp.quoth.quoth_read_chunks({
  chunk_ids: existingPatterns.chunks?.map(c => c.id).slice(0, 5) || []
})
```

#### Classify Findings

| Finding | Action |
|---------|--------|
| **NEW_PATTERN** - Pattern not in docs | Propose new documentation |
| **VIOLATION** - Code deviates from docs | Fix code OR update docs (if pattern is better) |
| **MATCH** - Code follows docs | No action needed |

#### Propose Documentation Updates

If NEW_PATTERN or improved VIOLATION found:

```typescript
await mcp.quoth.quoth_propose_update({
  doc_id: "patterns/playwright-test-patterns.md",
  new_content: `## Pattern: {name}\n\n**Use case**: {when to use}\n\n\`\`\`typescript\n{code}\n\`\`\``,
  evidence_snippet: "// Code from {ticket-id} tests",
  reasoning: "New pattern discovered during automated test generation"
})
```

#### Pattern Categories to Check

| Category | Document Path | Check For |
|----------|---------------|-----------|
| Authentication | `patterns/auth-patterns.md` | New auth flows, context setup |
| Locators | `patterns/locator-patterns.md` | Novel selector strategies |
| Wait strategies | `patterns/wait-patterns.md` | Custom timeout handling |
| Page objects | `patterns/page-object-patterns.md` | New page object patterns |
| Auto-healing | `patterns/test-healing-patterns.md` | Fixes that should be standard |

#### Documentation Checklist (Include in PR)

```markdown
## Documentation Evaluation

- [ ] Searched Quoth for existing patterns
- [ ] Compared generated code vs documented standards
- [ ] Proposed updates for new patterns (if any)
- [ ] Fixed violations OR proposed doc updates

**Patterns Evaluated**: {count}
**New Patterns Proposed**: {count}
**Violations Fixed**: {count}
```

---

### 2. Verify Clean Git Status

```bash
# Check for uncommitted changes
git status

# Stage any remaining files
git add automation/playwright/tests/{feature}/
git add docs/test-analysis/
git add docs/test-plans/
```

### 3. Push Branch to Origin

```bash
git push -u origin test/{ticket-id}-automated-tests
```

### 4. Generate PR Description

Create comprehensive PR body:

```markdown
## Summary

Automated Playwright E2E tests for [{TICKET-ID}]({linear-url})

### What's Included
- {count} test scenarios covering acceptance criteria
- Page objects: {list}
- Test utilities: {list}

### Test Coverage

| Category | Count | Status |
|----------|-------|--------|
| Happy Path | {n} | Passing |
| Edge Cases | {n} | Passing |
| Error Handling | {n} | Passing |

### Auto-Healing Applied

{healing-summary}

### How to Run

```bash
# Run all new tests
npx playwright test --project=chrome-{feature}

# Run with UI mode
npx playwright test --project=chrome-{feature} --ui
```

### Related
- Linear: [{TICKET-ID}]({linear-url})
- Test Plan: `docs/test-plans/{ticket-id}-test-plan.md`

---
Co-Authored-By: Claude Code <noreply@anthropic.com>
```

### 5. Create Pull Request

```bash
gh pr create \
  --title "test: automated tests for {ticket-id}" \
  --body "$(cat <<'EOF'
## Summary
...PR body from template above...
EOF
)" \
  --label "automated-tests,qa,e2e"
```

### 6. Link PR to Linear Ticket

```typescript
await mcp.linear.update_issue({
  id: ticketId,
  linkPullRequest: prUrl
})
```

### 7. Wait for Vercel Preview Deployment

**IMPORTANT**: After creating the draft PR, wait for Vercel to build the preview deployment.

```bash
# Get the preview URL from Vercel deployment
# Vercel builds take approximately 100 seconds
gh pr checks --watch --fail-fast

# Alternative: Check Vercel deployment status directly
vercel inspect --wait
```

**Expected preview URL format**:
```
https://{project}-{branch}-{org}.vercel.app
# Example: https://attorney-share-mvp-web-test-eng-123-attorneyshare.vercel.app
```

---

### 8. Execute Tests on Preview Deployment

**CRITICAL**: Run generated tests against the preview branch deployment before marking PR as ready.

#### Test Environment Configuration

| Component | Environment | URL |
|-----------|-------------|-----|
| **Frontend** | Preview Branch | `{vercel-preview-url}` (from step 7) |
| **Backend** | QA | `https://api-qa.attorneyshare.info/graphql` |

#### Run Tests Against Preview

```bash
# Set environment variables for preview testing
export BASE_URL="{vercel-preview-url}"
export GRAPHQL_ENDPOINT="https://api-qa.attorneyshare.info/graphql"

# Run the generated tests against preview deployment
npx playwright test --project=chrome-{feature} \
  --config=playwright.config.ts

# Or with explicit base URL override
npx playwright test --project=chrome-{feature} \
  --config=playwright.config.ts \
  -- --base-url="{vercel-preview-url}"
```

#### Programmatic Execution

```typescript
// Execute tests against preview environment
const testConfig = {
  baseURL: previewUrl,  // From Vercel deployment
  graphqlEndpoint: "https://api-qa.attorneyshare.info/graphql"
}

// Run Playwright with preview config
await exec(`npx playwright test --project=chrome-${feature}`, {
  env: {
    ...process.env,
    BASE_URL: testConfig.baseURL,
    GRAPHQL_ENDPOINT: testConfig.graphqlEndpoint
  }
})
```

#### Validate Test Results on Preview

```typescript
// Check test results
const results = await parsePlaywrightResults('./test-results')

if (results.failed > 0) {
  // Apply auto-healing (same as Step 5)
  await healFailures(results.failures, { maxAttempts: 3 })

  // Re-run tests after healing
  await exec(`npx playwright test --project=chrome-${feature} --last-failed`)
}
```

#### Update PR with Preview Test Results

```bash
# Add comment to PR with preview test results
gh pr comment --body "$(cat <<'EOF'
## ğŸ§ª Preview Deployment Test Results

**Environment:**
- Frontend: {vercel-preview-url}
- Backend: https://api-qa.attorneyshare.info/graphql

**Results:**
| Metric | Count |
|--------|-------|
| âœ… Passed | {passed} |
| âŒ Failed | {failed} |
| â­ï¸ Skipped | {skipped} |

{failure-details-if-any}

---
Tested by Quolar Test Automation
EOF
)"
```

#### Decision Matrix After Preview Testing

| Preview Result | Action |
|----------------|--------|
| âœ… All tests pass | Mark PR as ready for review |
| âš ï¸ Some failures, auto-healed | Commit fixes, re-push, re-test |
| âŒ Persistent failures | Add `test.fixme()`, document in PR, request human review |

---

### 9. Mark PR Ready for Review (if tests pass)

```bash
# Convert from draft to ready for review
gh pr ready

# Or if tests failed, keep as draft and add label
gh pr edit --add-label "needs-investigation"
```

---

### 10. Validate CI Execution (Optional)

With Exolar MCP:

```typescript
const ciExecution = await mcp.exolar.query_exolar_data({
  dataset: "ci_executions",
  filters: { pr_number: prNumber },
  view_mode: "summary"
})
```

---

## PR Template

Full PR template for reference:

```markdown
## Summary

Automated Playwright E2E tests generated from Linear ticket [{TICKET-ID}]({url}).

## Changes

### New Test Files
- `automation/playwright/tests/{feature}/{test}.spec.ts`

### Documentation
- `docs/test-analysis/{ticket-id}.md` - Ticket analysis
- `docs/test-plans/{ticket-id}-test-plan.md` - Test plan

### Configuration
- Updated `playwright.config.ts` (if applicable)
- Updated `.github/workflows/ci.yml` (if applicable)

## Test Results

### Execution Summary
| Metric | Value |
|--------|-------|
| Total Tests | {n} |
| Passed | {n} |
| Auto-Healed | {n} |
| Needs Review | {n} |

### Coverage by Acceptance Criteria
- [x] AC1: {description}
- [x] AC2: {description}
- [ ] AC3: {description} (marked as fixme)

## Auto-Healing History

| Test | Original Error | Fix Applied |
|------|---------------|-------------|
| `login.spec.ts` | Locator not found | Added `:visible` |

## How to Test

```bash
# Run all tests
npx playwright test --project=chrome-{feature}

# Run specific test
npx playwright test {test-file}

# Run with UI
npx playwright test --ui
```

## Checklist

- [x] Tests follow project patterns
- [x] Page objects reused where possible
- [x] Proper wait strategies used
- [x] CI configuration updated
- [x] Documentation generated

---

**Generated by Quolar Test Automation**
Co-Authored-By: Claude Code <noreply@anthropic.com>
```

---

## Output

- GitHub PR created and linked to Linear ticket
- CI workflow triggered
- Test artifacts available for review

---

## Post-Creation

After PR is created and preview tests pass:

1. **PR is Ready for Review** - Human reviewer can approve
2. **Merge when approved** - After code review and CI passes
3. **Tests run on merge** - Full CI pipeline executes on main branch

---

## Complete Workflow Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PR Creation Flow                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. Evaluate Documentation (Quoth)                          â”‚
â”‚           â†“                                                  â”‚
â”‚  2. Create Draft PR                                         â”‚
â”‚           â†“                                                  â”‚
â”‚  3. Wait for Vercel Preview (~100s)                         â”‚
â”‚           â†“                                                  â”‚
â”‚  4. Execute Tests on Preview                                â”‚
â”‚     â€¢ Frontend: Preview Branch URL                          â”‚
â”‚     â€¢ Backend: QA (https://api-qa.attorneyshare.info)       â”‚
â”‚           â†“                                                  â”‚
â”‚  5. Tests Pass? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚     â”‚ YES                       NO   â”‚                      â”‚
â”‚     â†“                               â†“                       â”‚
â”‚  Mark PR Ready              Auto-heal & Retry               â”‚
â”‚     â†“                               â†“                       â”‚
â”‚  Human Review              Still Failing?                   â”‚
â”‚     â†“                          â”‚ YES    â”‚ NO                â”‚
â”‚  Merge to Main           Keep Draft  â†’  Retry               â”‚
â”‚                          + Label                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Environment Reference

| Environment | Frontend URL | Backend GraphQL |
|-------------|--------------|-----------------|
| **Local** | `http://localhost:5173` | `http://localhost:8080/graphql` |
| **Preview** | `https://{branch}.vercel.app` | `https://api-qa.attorneyshare.info/graphql` |
| **QA** | Vercel Preview | `https://api-qa.attorneyshare.info/graphql` |
| **Staging** | `https://app.attorneyshare.info` | `https://api.attorneyshare.info/graphql` |
| **Production** | `https://app.attorneyshare.com` | `https://api.attorneyshare.com/graphql` |

**For test-ticket skill**: Always use **Preview Frontend + QA Backend**
